<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<link rel="stylesheet" type="text/css" href="css/editor.css">
		<script type="text/javascript" src="js/jszip/jszip.js"></script>
		<script type="text/javascript" src="js/jszip/jszip-load.js"></script>
		<script type="text/javascript" src="js/jszip/jszip-inflate.js"></script>
		<script src="js/jquery.js"></script>
		<script src="js/point.js"></script>
		<script src="js/sprite.js"></script>
		<script src="js/spritepack.js"></script>
		<script src="js/progress_bar.js"></script>
		<script src="js/editor.js"></script>
		<script src="js/sprite_properties_view.js"></script>
		
		<script type="text/javascript">
			var LUA;
			function playStep() {
				SpritePropertiesView.onSpriteForward();
				//$("#sprite_properties > #sprite_slider > #forward").click();	
				if( SpritePropertiesView.currentSprite() < SpritePropertiesView.spriteNumber() )
				{
					window.setTimeout(playStep, 100);
				}
			}
			$(document).ready
			(
				function()
				{
					var a = Editor;
					a.init();
					SpritePropertiesView.init();
					ProgressBar.init();
					document.oncontextmenu	= new Function("return false");
					
					$("#anim").click( function() { playStep(); } );
					$("#import").click( function() { $("#import_spritepack").click(); } );
					$("#import_spritepack").change
					(
						function()
						{
							var item = $("#import_spritepack")[0].files[0];
							$(this).val("");
							if( item.type !== "application/zip" ) 
							{
								//and then
							}
							
							var reader = new FileReader();
							
							reader.onload = function(e)
							{
								var zip = new JSZip( e.target.result );
								ProgressBar.show( zip.file(/img/).length, function(){ ProgressBar.hide(); } );
								Editor.mSpritePack.load
								(
									zip,
									function()
									{
										Editor.currentSpriteIndex( Editor.mSpritePack.size() - 1 );
										SpritePropertiesView
												.spriteNumber( Editor.spriteNumber() - 1 )
												.currentSprite( Editor.currentSpriteIndex() )
												.updateSpriteVal( Editor.currentSprite() );
										Editor.show();
									},
									function()
									{
										ProgressBar.add( 1 );
									}
								);
							}
							reader.readAsArrayBuffer( item );
						}
					);
					
					$("#download").click(
						function()
						{
							var pack	= Editor.mSpritePack.dump();
							var zip		= new JSZip();
							var lua		= "spritepack = {\n";
							
							for( var i = 0; i < pack.length; ++i )
							{
								zip.file("img_" + i + pack[i].image_type, pack[i].image, { base64: true });
								
								lua += "\t{\n";
								lua +="\t\tname    = \""	+ pack[i].name		+ "\",\n";
								lua +="\t\tgroup   = "		+ pack[i].group		+ ",\n";
								lua +="\t\tindex   = "		+ pack[i].index		+ ",\n";
								lua +="\t\txoffset = "		+ pack[i].xoffset	+ ",\n";
								lua +="\t\tyoffset = "		+ pack[i].yoffset	+ ",\n";
								lua +="\t\timage   = \"img_" + i + pack[i].image_type + "\"\n";
								lua +="\t},\n";
								ProgressBar.add(1);
							}
							lua += "}";
							zip.file( "spritepack.lua", lua );
							
							
							var blobLink = document.getElementById('download');
							try
							{
								blobLink.download	= "spritepack.zip";
								blobLink.href		= window.URL.createObjectURL( zip.generate({ type: "blob" }) );
							}
							catch(e)
							{
								blobLink.innerHTML += " (not supported on this browser)";
							}
						}
					);
				}
			);
			
		</script>
	</head>
	<body>
		<progress id="progressbar" value="10" max="100"></progress> 
		<ul id="menu">
			<li><a href="#" id="import">Import</a></li>
			<li><a href="#" id="download">Export</a></li>
			<li><input id="addimg" type="file" accept=".png,.pcx,.bmp,.jpeg,.jpg" multiple = "multiple"></li>
			<li><input id="import_spritepack" type="file" accept=".zip"></li>
		</ul>
		<canvas id="viewport" class="viewport"></canvas>
		<div id="sprite_properties">
			<h1>Sprite properties</h1>
			<div>
				<div>
					<span><input id="add" type="button" value="Add"/></span><span><input id="del" type="button" value="Del"/></span>
				</div>
			</div>
			<div id="sprite_slider">
				<button id="backward"> < </button>
				<input type="range" min="0" max="0" value="0" step="1"/>
				<button id="forward"> > </button>
			</div>
			<div>
				<div>Name or Comment</div>
				<div><input id="name" type="text"></div>
				<div><input id="anim" type="button" value="clica para preview"></div>
				<div><span>Group</span><span>Index</span></div>
				<div><span><input min="0" value="0"id="group" type="number"></span><span><input min="0" value="0" id="index" type="number"></span></div>
				<div><span>XOffset</span><span>YOffset</span></div>
				<div><span><input min="0" value="0"id="xoffset" type="number"></span><span><input min="0" value="0" id="yoffset" type="number"></span></div>
			</div>
			<div><input id="onionskin" type="button" value="+"/> Onion Skin</div>
			<div id="onionskin_menu">
				<div><span><input value="0" name="onionskin" type="radio"/></span><span>Disabled</span></div>
				<div><span><input value="1" name="onionskin" type="radio" checked /></span><span>Last sprite</span></div>
				<div><span><input value="2" name="onionskin" type="radio"/></span><span>Fixed</span></div>
				<div><span>Group</span><span>Index</span></div>
				<div><span><input min="0" value="0"id="onionskin_group" type="number"></span><span><input min="0" value="0" id="onionskin_index" type="number"></span></div>
			</div>
		</div>
	</body>
	
</html>
